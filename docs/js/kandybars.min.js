/*
 * The MIT License (MIT)
 *
 * Copyright (c) 2017 Karl STEIN
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */

"use strict";function evalCondition(condition){var __kbRes=void 0;return"string"==typeof condition&&condition.length>0&&(condition=condition.replace(/[\r\n]/g,"")),eval("__kbRes = ( "+condition+" );"),__kbRes}function extend(){for(var e=1;e<arguments.length;e+=1)for(var t in arguments[e])arguments[e].hasOwnProperty(t)&&(arguments[0][t]=arguments[e][t]);return arguments[0]}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},reservedWords=["abstract","arguments","boolean","break","byte","case","catch","char","class","const","continue","debugger","default","delete","do","double","else","enum","eval","export","extends","false","final","finally","float","for","function","goto","if","implements","import","in","instanceof","int","interface","let","long","native","new","null","package","private","protected","public","return","short","static","super","switch","synchronized","this","throw","throws","transient","true","try","typeof","let","void","volatile","while","with","yield"],blockPattern=/{{#each ((?:this\.|\.\.\/)?[a-zA-Z0-9_]+(?:\.[a-zA-Z0-9_]+)*)}}([\s\S]*?){{\/each}}/g,commentPattern=/{{![^}]+?}}/g,evalPattern=/{{\eval ([^}]+)}}/g,expressionPattern=/{{#if ([^}]+)}}((?:(?!{{#if)[\s\S])*?){{\/if}}/g,helperPattern=/{{([a-zA-Z0-9_]+) ([^}]+)}}/g,pathPattern=/^(?:this\.|\.\.\/)?[a-zA-Z_][a-zA-Z0-9_]*(?:\.[a-zA-Z0-9_]+)*$/,partialPattern=/{{> *([^ }]+)( +[^}]+)*}}/g,templatePattern=/<template[^>]*>([\s\S]*?)<\/template>/g,templateNamePattern=/name="([^"]+)"/,templateTagsPattern=/<template[^>]*>|<\/template>|/g,valuePattern=/\b((?:this\.|\.\.\/)?[a-zA-Z_$][a-zA-Z0-9_$]*(?:\.[a-zA-Z0-9_$]+)*)\b(?!["'])/g,varPattern=/{{{?((?:this\.|\.\.\/)?[a-zA-Z0-9_]+(?:\.[a-zA-Z0-9_]+)*)}}}?/g,withPattern=/{{#with ((?:this\.|\.\.\/)?[a-zA-Z0-9_]+(?:\.[a-zA-Z0-9_]+)*)}}([\s\S]*?){{\/with}}/g,partials={},Template={},instanceCount=0,Kandybars={cache:!1,helpers:{},create:function(e,t){return Template[e]=new Kandybars.Template(e,t)},exists:function(e){return Template.hasOwnProperty(e)},load:function(e,t){var n=this;"string"==typeof e?this.loadFile(e,t):e instanceof Array&&function(){for(var r=e.length,a=0;a<e.length;a+=1)n.loadFile(e[a],function(e){r-=e?0:1,(e||0===r)&&"function"==typeof t&&t.call(Kandybars,e)})}()},getTemplatesLogic:function(){return Template},loadFile:function loadFile(url,callback){var fileType=url.substr(url.lastIndexOf(".")+1),req=new XMLHttpRequest;switch(req.onerror=function(e){"function"==typeof callback&&callback.call(Kandybars,new Error("Cannot load file : "+url,e.target.status))},req.onreadystatechange=function(){if(4===req.readyState)if(200===req.status){switch(fileType){case"js":eval(req.responseText);break;case"html":case"hbml":case"kbml":case"tpl":Kandybars.parseTemplates(req.responseText)}"function"==typeof callback&&callback.call(Kandybars,null)}else"function"==typeof callback&&callback.call(Kandybars,new Error("Cannot load file : "+url))},req.open("GET",url,!0),fileType){case"html":case"hbml":case"kbml":case"tpl":req.overrideMimeType("text/plain")}req.send(null)},parseHelperArguments:function(e,t,n){for(var r=[],a=e.split(" "),l=0;l<a.length;l+=1){var i=a[l][0],o=a[l].slice(-1);if('"'!==i&&"'"!==i||i===o&&"\\"+o!==a[l].slice(-2))r.push(a[l]);else for(var s=[a[l]],p=l+1;p<a.length;p+=1)if(o=a[p].slice(-1),s.push(a[p]),o===i&&"\\"+o!==a[p].slice(-2)){l=p,r.push(s.join(" "));break}}for(var c=0;c<r.length;c+=1){var u=Kandybars.parseValue(r[c],t,n);/^(["'])[^\1]+?\1$/.test(u)&&(u=u.substring(1,u.length-1)),r[c]=u}return r},parseHelperParams:function(e,t,n){var r={};if("string"==typeof e)for(var a=e.trim().split(" "),l=0;l<a.length;l+=1){var i=a[l].trim().split("=",2),o=i[0].trim();if("this"===o){var s=Kandybars.parseValue(i[1],t,n);"object"===(void 0===s?"undefined":_typeof(s))&&(r=extend({},s,r))}else r[o]=Kandybars.parseValue(i[1],t,n)}return r},parseTemplates:function(e){for(var t=e.match(templatePattern),n=0;n<t.length;n+=1){var r=t[n],a=r.match(templateNamePattern)[1],l=r.replace(templateTagsPattern,"");Kandybars.create(a,l)}return t},parseValue:function(e,t,n){if(null!==e&&void 0!==e){if(/^(['"])[^\1]+?\1$/.test(e))return e.replace(/^['"]/g,"").replace(/['"]$/g,"");if(["+","-","*","/"].indexOf(e)!==-1)return e;if(reservedWords.indexOf(e)!==-1)return e;if(pathPattern.test(e)&&(e=Kandybars.resolvePath(e,t,n)),null!==e&&void 0!==e){if(/^true$/i.test(e))return!0;if(/^false$/i.test(e))return!1;if(/^[+-]?(?:[0-9]+|Infinity)$/.test(e))return parseInt(e);if(/^[+-]?(?:[0-9]+\.[0-9]+$)/.test(e))return parseFloat(e);"string"==typeof e&&(e='"'+e.replace(/"/g,'\\"')+'"')}}return e},registerHelper:function(e,t){if("string"!=typeof e||e.length<1)throw new Error("invalid helper name");if("function"!=typeof t)throw new Error("invalid helper callback");Kandybars.helpers[e]=t},render:function(e,t,n){if(!this.exists(e))throw'The template "'+e+'" does not exist';return Template[e].createInstance(t,n).render(n)},renderHTML:function(e,t,n){var r="tpl_"+Date.now();Kandybars.create(r,e);var a=Kandybars.render(r,t,n);return delete Template[r],a},resolvePath:function(e,t,n){if(n=n||{},"string"==typeof e&&null!==t&&void 0!==t){if(n.special&&n.special.hasOwnProperty(e))return n.special[e];if(!pathPattern.test(e))return null;if("this"===e)return t;if("object"===(void 0===t?"undefined":_typeof(t))){var r=t;if(0===e.indexOf("../")?(r=n.parent&&n.parent.parent?n.parent.parent.data||{}:{},e=e.substring(3)):0===e.indexOf("this.")&&(r=t,e=e.substring(5)),null!==r)for(var a=e.split("."),l=a.length,i=0;i<l;i+=1){if(null===r||"object"!==(void 0===r?"undefined":_typeof(r))||!r.hasOwnProperty(a[i])){r=null;break}null!==(r=r[a[i]])&&"function"==typeof r&&(r=r.call(t))}return r}}return null}};Kandybars.Template=function(e,t){var n=this;n._events={},n._helpers={},n._source=t,n.name=e,n.rendered=null,n.getEvents=function(){return n._events},n.getHelpers=function(){return n._helpers},n.getName=function(){return n.name},n.getSource=function(){return n._source}},Kandybars.Template.prototype.createInstance=function(e,t){return new Kandybars.TemplateInstance(this,e,t)},Kandybars.Template.prototype.events=function(e){if(null!==e&&"object"===(void 0===e?"undefined":_typeof(e)))for(var t in e)e.hasOwnProperty(t)&&(this._events[t]=e[t])},Kandybars.Template.prototype.helpers=function(e){if(null!==e&&"object"===(void 0===e?"undefined":_typeof(e)))for(var t in e)e.hasOwnProperty(t)&&(this._helpers[t]=e[t])},Kandybars.TemplateInstance=function(e,t,n){var r=this;instanceCount+=1,n=extend({events:{},helpers:{},parent:null,partial:!1,rendered:null},n);var a=[],l="kbti_"+instanceCount,i=n.parent;n.partial&&(partials[l]=this),i&&i.instance instanceof Kandybars.TemplateInstance&&i.instance.getChildren().push(this),r.attachEvent=function(e,t,n){var r=this;if("function"==typeof t)for(var a=e.split(","),l=0;l<a.length;l+=1){e=a[l];var i=e.split(" ",2),o=i[0],s=i[1],p=s&&n.filter(s);p&&1===p.length&&(n=p,s=null),function(e,a){n.on(e,a,function(e){t.call(r.getContext(),e,n,r)})}(o,s)}},r.attachEvents=function(e,t){for(var n in e)e.hasOwnProperty(n)&&r.attachEvent(n,e[n],t)},r.getChildren=function(){return a},r.getContext=function(){return extend({},t,e._helpers)},r.getEvents=function(){return extend({},r.getTemplate().getEvents(),n.events)},r.getHelpers=function(){return extend({},r.getTemplate().getHelpers(),n.helpers)},r.getId=function(){return l},r.hasChildren=function(){return a.length>0},r.isPartial=function(){return n.partial===!0},r.getParent=function(){return i&&i.instance},r.getTemplate=function(){return e},r._rendered=function(){"function"==typeof n.rendered?n.rendered.call(r,r.compiled,r.getContext()):"function"==typeof r.getTemplate().rendered&&r.getTemplate().rendered.call(r,r.compiled,r.getContext())}},Kandybars.TemplateInstance.prototype.render=function(e){e=extend({events:{},helpers:{},html:!1,parent:null,rendered:null},e);var t=this,n=t.getContext(),r=t.getTemplate(),a=r.getSource(),l=t.replaceAll(a,n,e);if(t.isPartial()){var i=t.getId(),o=l.indexOf("<"),s=l.indexOf(">",o);l=o===-1||s===-1?'<div data-partial-id="'+i+'">'+l+"</div>":l.substr(0,s)+' data-partial-id="'+i+'"'+l.substr(s)}else if(!e.html&&"undefined"!=typeof jQuery){l=jQuery(l),e.target&&jQuery(e.target).html(l);var p=function(){var e=jQuery(this),t=e.attr("data-partial-id"),n=partials[t];n.compiled=jQuery(this),n.attachEvents(n.getEvents(),e),n._rendered()};l.filter("[data-partial-id]").each(p),l.find("[data-partial-id]").each(p),t.attachEvents(t.getEvents(),l)}return t.compiled=l,e.html||t._rendered(),l},Kandybars.TemplateInstance.prototype.replaceAll=function(e,t,n){if(t)for(var r in t)t.hasOwnProperty(r)&&"function"==typeof t[r]&&(t[r]=t[r].call(t));return n||(n={}),e=this.replaceComments(e),e=this.replaceConditions(e,t,n),e=this.replaceBlocks(e,t,n),e=this.replacePartials(e,t,n),e=this.replaceWith(e,t,n),e=this.replaceEvals(e,t,n),e=this.replaceHelpers(e,t,n),e=this.replaceVars(e,t,n),e=this.replaceAttributes(e)},Kandybars.TemplateInstance.prototype.replaceAttributes=function(e){return e.replace(/(?:disabled|checked|selected)=["'](?:false)?["']/gim,"")},Kandybars.TemplateInstance.prototype.replaceBlocks=function(e,t,n){var r=this;return e.replace(blockPattern,function(e,a,l){var i=Kandybars.resolvePath(a,t,n),o="",s={},p="";if(null!==i&&void 0!==i)if(i instanceof Array||"number"==typeof i.length)for(var c=0;c<i.length;c+=1)s=i[c],"object"===(void 0===s?"undefined":_typeof(s))&&(s["@index"]=c),p=l.replace("{{@index}}",c),p=p.replace("@index",String(c)),o+=r.replaceAll(p,s,{special:{"@index":c},parent:{data:t,parent:n}});else if("object"===(void 0===i?"undefined":_typeof(i)))for(var u in i)i.hasOwnProperty(u)&&(s=i[u],"object"===(void 0===s?"undefined":_typeof(s))&&(s["@key"]=u),p=l.replace("{{@key}}",u),p=p.replace("@key",u),o+=r.replaceAll(p,s,{special:{"@key":u},parent:{data:t,parent:n}}));return o})},Kandybars.TemplateInstance.prototype.replaceComments=function(e){return e.replace(commentPattern,"")},Kandybars.TemplateInstance.prototype.replaceConditions=function(e,t,n){for(var r=this;e.indexOf("{{#if")!==-1;)e=e.replace(expressionPattern,function(e,a,l){var i="",o=l.split("{{else}}");l=o[0];var s=o[1];return a=a.replace(valuePattern,function(e,r){return Kandybars.parseValue(r,t,n)}),evalCondition(a)?"string"==typeof l&&(i=r.replaceAll(l,t,{parent:{data:t,parent:n}})):"string"==typeof s&&(i=r.replaceAll(s,t,{parent:{data:t,parent:n}})),i});return e},Kandybars.TemplateInstance.prototype.replaceEvals=function(e,t,n){return e.replace(evalPattern,function(e,r){return evalCondition(Kandybars.parseHelperArguments(r,t,n).join(" "))})},Kandybars.TemplateInstance.prototype.replaceHelpers=function(e,t,n){return e.replace(helperPattern,function(e,r,a){if(a=Kandybars.parseHelperArguments(a,t,n),void 0===Kandybars.helpers[r])throw new Error('Helper "'+r+'" does not exist');var l=Kandybars.helpers[r];return"function"==typeof l&&(l=l.apply(t,a)),void 0!==l&&null!==l?l:""})},Kandybars.TemplateInstance.prototype.replacePartials=function(e,t,n){var r=this;return e.replace(partialPattern,function(e,a,l){l=Kandybars.parseHelperParams(l,t,n);var i=extend({},t,l);return Kandybars.render(a,i,{html:!0,parent:extend({},n,{instance:r}),partial:!0})})},Kandybars.TemplateInstance.prototype.replaceVars=function(e,t,n){return e.replace(varPattern,function(r,a){var l=Kandybars.resolvePath(a,t,n),i=void 0===l?"undefined":_typeof(l);if(/<option>/g.test(e)&&console.log("vars:",a,t,n,l),null!==l&&void 0!==l){if("string"===i||"number"===i||"boolean"===i)return l;if("object"===i)return l.hasOwnProperty("toString")?l.toString():l;if("function"===i){var o=n&&n.parent?n.parent:{};return l(t,o.data,o)}throw new Error('Cannot replace variable "'+a+'" of type "'+i+'"')}return""})},Kandybars.TemplateInstance.prototype.replaceWith=function(e,t,n){var r=this;return e.replace(withPattern,function(e,a,l){var i=Kandybars.resolvePath(a,t,n);if(null!==i&&void 0!==i&&"object"===(void 0===i?"undefined":_typeof(i)))return r.replaceAll(l,i,{parent:{data:t,parent:n}})})},"undefined"!=typeof jQuery&&(Kandybars.TemplateInstance.prototype.$=function(e){var t=jQuery(this.compiled);return null!==e?t.find(e):t},Kandybars.TemplateInstance.prototype.find=function(e){return this.$(e)});
